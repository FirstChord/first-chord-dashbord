{% extends "base.html" %}

{% block title %}Manage Sessions - Tutor Me{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-gear"></i> Manage Sessions</h1>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

{% if sessions_data %}
    {% for day_data in sessions_data %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-calendar3"></i> {{ day_data.date }}
                    <span class="badge bg-primary ms-2">{{ day_data.count }} sessions</span>
                </h5>
            </div>
            <div class="card-body">
                {% for session in day_data.sessions %}
                    <div class="border rounded p-3 mb-3 session-item" data-session-id="{{ session.id }}" data-file-name="{{ session.file_name }}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-2">
                                    <strong>Topic:</strong> 
                                    <span class="editable-topic">{{ session.topic }}</span>
                                    <button class="btn btn-sm btn-outline-primary ms-2 edit-btn" data-field="topic">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Source:</strong> {{ session.source }}
                                    <span class="badge bg-secondary ms-2">{{ session.timestamp[:10] }}</span>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Tags:</strong>
                                    <span class="editable-tags">
                                        {% if session.tags %}
                                            {% for tag in session.tags %}
                                                <span class="badge bg-info me-1">{{ tag }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No tags</span>
                                        {% endif %}
                                    </span>
                                    <button class="btn btn-sm btn-outline-primary ms-2 edit-btn" data-field="tags">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                                
                                {% if session.notes %}
                                    <div class="mb-2">
                                        <strong>Notes:</strong> 
                                        <span class="editable-notes">{{ session.notes }}</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2 edit-btn" data-field="notes">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                {% endif %}
                                
                                <div class="mt-3">
                                    <div class="d-flex">
                                        <div class="flex-grow-1 me-3">
                                            <strong>Q:</strong> {{ session.prompt[:100] }}{% if session.prompt|length > 100 %}...{% endif %}
                                        </div>
                                    </div>
                                    {% if session.assistant_reply %}
                                        <div class="mt-2 text-muted">
                                            <strong>A:</strong> {{ session.assistant_reply[:150] }}{% if session.assistant_reply|length > 150 %}...{% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <div class="btn-group-vertical" role="group">
                                    <button class="btn btn-sm btn-danger delete-session-btn mb-2" 
                                            data-session-id="{{ session.id }}" 
                                            data-file-name="{{ session.file_name }}">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="text-center py-5">
        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
        <h4 class="mt-3 text-muted">No Sessions Found</h4>
        <p class="text-muted">Start by capturing some study sessions!</p>
        <a href="{{ url_for('capture_session') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Capture First Session
        </a>
    </div>
{% endif %}

<div id="statusAlert" class="alert" style="display: none;" role="alert"></div>
{% endblock %}

{% block scripts %}
<script>
// Delete session functionality
document.querySelectorAll('.delete-session-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const sessionId = this.dataset.sessionId;
        const fileName = this.dataset.fileName;
        
        if (!confirm('Are you sure you want to delete this session?')) {
            return;
        }
        
        const originalText = this.innerHTML;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        this.disabled = true;
        
        fetch('/delete-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_name: fileName,
                session_id: sessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the session item from DOM
                const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
                sessionItem.remove();
                
                // Show success message
                const alert = document.getElementById('statusAlert');
                alert.className = 'alert alert-success';
                alert.innerHTML = '<i class="bi bi-check-circle"></i> Session deleted successfully';
                alert.style.display = 'block';
                
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting session: ' + error.message);
        })
        .finally(() => {
            this.innerHTML = originalText;
            this.disabled = false;
        });
    });
});

// Edit functionality (basic implementation)
document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const field = this.dataset.field;
        const sessionItem = this.closest('.session-item');
        const sessionId = sessionItem.dataset.sessionId;
        const fileName = sessionItem.dataset.fileName;
        
        const currentValue = field === 'tags' ? 
            Array.from(sessionItem.querySelectorAll(`.editable-${field} .badge`)).map(badge => badge.textContent).join(', ') :
            sessionItem.querySelector(`.editable-${field}`).textContent.trim();
        
        const newValue = prompt(`Edit ${field}:`, currentValue);
        
        if (newValue !== null && newValue !== currentValue) {
            const updates = {};
            updates[field] = field === 'tags' ? newValue.split(',').map(tag => tag.trim()).filter(tag => tag) : newValue;
            
            fetch('/update-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_name: fileName,
                    session_id: sessionId,
                    updates: updates
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the display
                    if (field === 'tags') {
                        const tagsContainer = sessionItem.querySelector(`.editable-${field}`);
                        const tags = updates[field];
                        tagsContainer.innerHTML = tags.length ? 
                            tags.map(tag => `<span class="badge bg-info me-1">${tag}</span>`).join('') :
                            '<span class="text-muted">No tags</span>';
                    } else {
                        sessionItem.querySelector(`.editable-${field}`).textContent = newValue;
                    }
                    
                    // Show success message
                    const alert = document.getElementById('statusAlert');
                    alert.className = 'alert alert-success';
                    alert.innerHTML = '<i class="bi bi-check-circle"></i> Session updated successfully';
                    alert.style.display = 'block';
                    
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 3000);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating session: ' + error.message);
            });
        }
    });
});
</script>
{% endblock %}